#!/bin/bash
# Auto Pull, Build, Deploy and Watch Script
# This script pulls changes from remote ClaudeCode, builds, deploys, and watches for errors

set -e

echo "üîÑ Auto Pull, Build, Deploy and Watch"
echo "======================================"

# Ensure we're on ClaudeCode branch
CURRENT_BRANCH=$(git branch --show-current)
if [ "$CURRENT_BRANCH" != "ClaudeCode" ]; then
    echo "‚ö†Ô∏è  Not on ClaudeCode branch. Switching..."
    git checkout ClaudeCode
fi

# Pull latest changes from remote
echo "üì• Pulling latest changes from origin/ClaudeCode..."
BEFORE_PULL=$(git rev-parse HEAD)
git pull origin ClaudeCode
AFTER_PULL=$(git rev-parse HEAD)

# Check if code files were changed
if [ "$BEFORE_PULL" != "$AFTER_PULL" ]; then
    CODE_CHANGED=$(git diff --name-only $BEFORE_PULL $AFTER_PULL | grep -E '\.(js|cds|json|yaml|yml)$|^srv/|^db/|^app/')

    if [ -z "$CODE_CHANGED" ]; then
        echo "No code changes detected (only docs/text files changed). Skipping build..."
        exit 0
    fi

    echo "Code changes detected:"
    echo "$CODE_CHANGED"
else
    echo "No new commits pulled. Nothing to build."
    exit 0
fi

# Install/update dependencies
echo "üì¶ Installing/updating dependencies..."
npm install

# Build the project
echo "üèóÔ∏è Running CDS build..."
BUILD_EXIT_CODE=0
npm run build || BUILD_EXIT_CODE=$?

if [ $BUILD_EXIT_CODE -ne 0 ]; then
    echo "‚ùå Build failed! Attempting auto-fix..."

    # Auto-fix common ES module issues
    echo "üîß Fixing ES module syntax..."
    find srv -name "*.js" -type f -print0 | while IFS= read -r -d '' file; do
        if grep -q "require('@sap/cds')" "$file"; then
            sed -i "s/const cds = require('@sap\/cds')/import cds from '@sap\/cds'/g" "$file"
            sed -i "s/module.exports = class/export default class/g" "$file"
            sed -i "s/module.exports = /export default /g" "$file"
            echo "  Fixed: $file"
        fi
    done

    # Retry build
    echo "üîÑ Retrying build after fixes..."
    if npm run build; then
        echo "‚úÖ Build successful after auto-fix!"

        # Commit and push fixes
        git add -A
        if git diff --staged --quiet; then
            echo "No changes to commit"
        else
            git commit -m "Auto-fix: Build errors resolved

ü§ñ Generated by auto-pull-build-watch script"
            echo "üì§ Pushing fixes to origin/ClaudeCode..."
            git push origin ClaudeCode

            # Merge to dev on remote using GitHub CLI
            echo "üîÄ Merging ClaudeCode to dev on remote..."
            gh api \
                --method POST \
                -H "Accept: application/vnd.github+json" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                /repos/:owner/:repo/merges \
                -f base='dev' \
                -f head='ClaudeCode' \
                -f commit_message='Auto-merge: ClaudeCode to dev after build fix' || echo "‚ö†Ô∏è  Merge may require manual intervention"
        fi
    else
        echo "‚ùå Build still failing after auto-fix. Manual intervention required."
        exit 1
    fi
fi

# Deploy to database
echo "üöÄ Running CDS deploy..."
if cds deploy; then
    echo "‚úÖ Deploy successful!"
else
    echo "‚ùå Deploy failed!"
    exit 1
fi

# Watch for changes
echo "üëÄ Starting CDS watch..."
echo "   Press Ctrl+C to stop"
cds watch
